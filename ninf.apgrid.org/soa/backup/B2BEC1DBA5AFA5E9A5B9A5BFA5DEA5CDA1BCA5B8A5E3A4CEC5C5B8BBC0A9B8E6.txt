>>>>>>>>>> 1251050307
[[FrontPage]]

= 外部アプリケーションによって電源 ON/OFF を制御する場合

- 物理ノードの電源 ON/OFF 状態を状態フラグとしてマネージャのデータベースに置く。
また、マネージャは、物理ノード状態を定期的に監視する。
- マネージャは外部アプリケーションの指示に従って物理ノードの電源 ON/OFF を行う。
- 物理ノードの状態に従って、当該ノードでの VM 稼働を抑制する。
これは、起動時の VM 配置を決定する外部アプリケーションが行う。
-- 電源 ON は随時実行できる。
-- VM が稼働していない物理ノードの電源 OFF は随時実行できる。
-- VM 起動処理中に物理ノードの電源 OFF が指示された場合、当該指示は拒否する。
-- VM 稼働中の物理ノードの電源 OFF が指示された場合、当該指示は拒否する。
-- マイグレーション込みでの電源 OFF が指示された場合、外部アプリケーションに電源 OFF 後の物理ノード群の状態を元に VM 配置の決定を要求する。
VM 再配置が可能であるならば、マイグレーションを行った上で電源 OFF を行う。

= マネージャが自律的に電源 ON/OFF を制御する場合

- 物理ノードの電源 ON/OFF 状態を状態フラグとしてマネージャのデータベースに置く。
また、マネージャは、物理ノード状態を定期的に監視する。
- 定期的に電源ON実行のための監視、電源OFF実行のための監視を実行する。

 電源ON実行のための監視(IN _物理ノード群, IN _稼働中VM群, IN _予約情報, IN _電源OnThresholdTime,
                        OUT _電源ON物理ノード群) :- 
	規定時間内に仮想クラスタの新規起動があるか?(_物理ノード群, _稼働中VMノード群, _予約情報),
	規定時間内に仮想クラスタを新規起動するのに必要な物理ノードは?(_電源OnThresholdTime,
								      _物理ノード群, _稼働中VM群, _予約情報, 
								      _電源ON物理ノード群, _新規VM群),
	!, 電源ON実行(_電源ON物理ノード群).

 電源OFF実行のための監視(IN _物理ノード群, IN _稼働中VM群, IN _予約情報, IN _電源OffThresholdTime,
                         OUT _不要化物理ノード群) :- 
	規定時間内に仮想クラスタの新規起動があるか?(_物理ノード群, _稼働中VMノード群, _予約情報),
	規定時間内に仮想クラスタを新規起動するのに必要な物理ノードは?(_電源OffThresholdTime,
								      _物理ノード群, _稼働中VM群, _予約情報, 
								      _電源ON物理ノード群, _新規VM群),
	concat(_電源ON物理ノード群, _物理ノード群, _規定時間後の物理ノード群),
	concat(_稼働中VM群, _新規VM群, _規定時間後のVM群),
	不要な物理ノードは?(_規定時間後の物理ノード群, _規定時間後のVM群,
			    _不要化物理ノード群),
	!, 電源OFF実行(_不要化物理ノード群).

 %%%%
 不要な物理ノードは?(IN [_規定時間後の物理ノード, _規定時間後の物理ノード群], IN _規定時間後のVM群,
		     OUT [_不要物理ノード, _不要化物理ノード群残り]) :-
	_規定時間後の物理ノード = _不要物理ノード,
	not VM稼働する物理ノードか?(_不要物理ノード, _規定時間後のVM群),
	不要な物理ノードは?(_規定時間後の物理ノード群, _規定時間後のVM群,
		            _不要化物理ノード群残り]).

 不要な物理ノードは?(IN [_規定時間後の物理ノード, _規定時間後の物理ノード群], IN _規定時間後のVM群,
		     OUT _不要化物理ノード群) :-
	不要な物理ノードは?(_規定時間後の物理ノード群, _規定時間後のVM群,
		            _不要化物理ノード群]).
>>>>>>>>>> 1251058218
[[FrontPage]]

* 検討資料 [#p137d13c]

仮想クラスタマネージャは物理ノードの電源 ON/OFF をどのように制御するべきか
の検討資料

** 外部アプリケーションによって電源 ON/OFF を制御する場合 [#m521c97d]

- 物理ノードの電源 ON/OFF 状態を状態フラグとしてマネージャのデータベースに置く。
また、マネージャは、物理ノード状態を定期的に監視する。
- マネージャは外部アプリケーションの指示に従って物理ノードの電源 ON/OFF を行う。
- 物理ノードの状態に従って、当該ノードでの VM 稼働を抑制する。
これは、起動時の VM 配置を決定する外部アプリケーションが行う。
-- 電源 ON は随時実行できる。
-- VM が稼働していない物理ノードの電源 OFF は随時実行できる。
-- VM 起動処理中に物理ノードの電源 OFF が指示された場合、当該指示は拒否する。
-- VM 稼働中の物理ノードの電源 OFF が指示された場合、当該指示は拒否する。
-- マイグレーション込みでの電源 OFF が指示された場合、外部アプリケーションに電源 OFF 後の物理ノード群の状態を元に VM 配置の決定を要求する。
VM 再配置が可能であるならば、マイグレーションを行った上で電源 OFF を行う。

** マネージャが自律的に電源 ON/OFF を制御する場合 [#n5ef1026]

- 物理ノードの電源 ON/OFF 状態を状態フラグとしてマネージャのデータベースに置く。
また、マネージャは、物理ノード状態を定期的に監視する。
- 定期的に電源ON実行のための監視、電源OFF実行のための監視を実行する。

 電源ON実行のための監視(IN _物理ノード群, IN _稼働中VM群, IN _予約情報, IN _電源OnThresholdTime,
                        OUT _電源ON物理ノード群) :- 
	規定時間内に仮想クラスタの新規起動があるか?(_物理ノード群, _稼働中VMノード群, _予約情報, _電源OnThresholdTime),
	規定時間内に仮想クラスタを新規起動するのに必要な物理ノードは?(_電源OnThresholdTime,
								      _物理ノード群, _稼働中VM群, _予約情報, 
								      _電源ON物理ノード群, _新規VM群),
	!, 電源ON実行(_電源ON物理ノード群).
 電源ON実行のための監視(IN _物理ノード群, IN _稼働中VM群, IN _予約情報, IN _電源OnThresholdTime,
                        OUT []).

 電源OFF実行のための監視(IN _物理ノード群, IN _稼働中VM群, IN _予約情報, IN _電源OffThresholdTime,
                         OUT _不要化物理ノード群) :- 
	規定時間内に仮想クラスタの新規起動があるか?(_物理ノード群, _稼働中VMノード群, _予約情報, _電源OffThresholdTime),
	規定時間内に仮想クラスタを新規起動するのに必要な物理ノードは?(_電源OffThresholdTime,
								      _物理ノード群, _稼働中VM群, _予約情報, 
								      _電源ON物理ノード群, _新規VM群),
	concat(_電源ON物理ノード群, _物理ノード群, _規定時間後の物理ノード群),
	concat(_稼働中VM群, _新規VM群, _規定時間後のVM群),
	不要な物理ノードは?(_規定時間後の物理ノード群, _規定時間後のVM群,
			    _不要化物理ノード群),
	!, 電源OFF実行(_不要化物理ノード群).
 電源OFF実行のための監視(IN _物理ノード群, IN _稼働中VM群, IN _予約情報, IN _電源OffThresholdTime,
                         OUT [])

 %%%%
 不要な物理ノードは?(IN [_規定時間後の物理ノード | _規定時間後の物理ノード群], IN _規定時間後のVM群,
		     OUT [_不要物理ノード | _不要化物理ノード群残り]) :-
	_規定時間後の物理ノード = _不要物理ノード,
	not VM稼働する物理ノードか?(_不要物理ノード, _規定時間後のVM群),
	不要な物理ノードは?(_規定時間後の物理ノード群, _規定時間後のVM群,
		            _不要化物理ノード群残り).
 不要な物理ノードは?(IN [_規定時間後の物理ノード | _規定時間後の物理ノード群], IN _規定時間後のVM群,
		     OUT _不要化物理ノード群) :-
	不要な物理ノードは?(_規定時間後の物理ノード群, _規定時間後のVM群,
		            _不要化物理ノード群).

規定時間内に仮想クラスタを新規起動するのに必要な物理ノードは?/6 は、外部に
問い合わせを行う。問い合わせの度に応答が変化する可能性がある場合には、
結果をキャッシュし、同一問い合わせは発行しないこととしなければならない。

*** 電源 ON/OFF threshold time [#neb6d075]
- _電源OffThresholdTime < _電源OnThresholdTime の場合
 電源 ON/OFF が繰り返されるので NG
 推論処理にもう一段加えて、「電源ONが発生するなら電源OFFしない」とする?
- _電源OffThresholdTime = _電源OnThresholdTime の場合
 電源 OFF 直後に電源 ON が行われる可能性がある。
- _電源OffThresholdTime > _電源OnThresholdTime の場合
 少なくとも、(_電源OffThresholdTime) - (_電源OnThresholdTime) の時間は
 電源 OFF が保証される。

